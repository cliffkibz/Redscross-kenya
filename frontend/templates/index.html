{% extends "base.html" %}
{% block title %}Home - Red Cross Kenya{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const bgImages = [
        '/static/logo/req.jpg',
        '/static/logo/vol.jpg',
        '/static/logo/Careers.png',
        '/static/logo/hero.png'
    ];
    let bgIndex = 0;
    const bgSlideshow = document.getElementById('bg-slideshow');
    function setBgImage(idx) {
        bgSlideshow.style.backgroundImage = `url('${bgImages[idx]}')`;
    }
    setBgImage(bgIndex);
    setInterval(() => {
        bgIndex = (bgIndex + 1) % bgImages.length;
        setBgImage(bgIndex);
    }, 5000);
    function getToken() {
        return localStorage.getItem('auth_token');
    }
    function fetchLiveAlerts() {
        const token = getToken();
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        fetch('/api/incidents/?per_page=5', { headers })
            .then(response => {
                if (response.status === 401) {
                    const alertsList = document.getElementById('live-alerts');
                    alertsList.innerHTML = '<li>Please log in to view real-time alerts.</li>';
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (!data) return;
                const alertsList = document.getElementById('live-alerts');
                alertsList.innerHTML = '';
                if (data.incidents && data.incidents.length > 0) {
                    data.incidents.forEach(incident => {
                        let icon = '<i class="fas fa-exclamation-triangle text-danger"></i>';
                        if (incident.incident_type && incident.incident_type.toLowerCase().includes('fire')) {
                            icon = '<i class="fas fa-fire text-warning"></i>';
                        } else if (incident.incident_type && incident.incident_type.toLowerCase().includes('accident')) {
                            icon = '<i class="fas fa-car-crash text-primary"></i>';
                        }
                        const location = incident.location ? incident.location : 'Unknown';
                        const time = new Date(incident.created_at).toLocaleString();

                        let severityLabel = '';
                        let severityDesc = '';
                        let severityClass = '';
                        switch ((incident.severity || '').toLowerCase()) {
                            case 'critical':
                                severityLabel = 'Critical';
                                severityDesc = 'Life-threatening, immediate action required';
                                severityClass = 'bg-danger';
                                break;
                            case 'high':
                                severityLabel = 'High';
                                severityDesc = 'Serious, urgent response needed';
                                severityClass = 'bg-warning text-dark';
                                break;
                            case 'medium':
                                severityLabel = 'Medium';
                                severityDesc = 'Moderate impact, needs attention';
                                severityClass = 'bg-info text-dark';
                                break;
                            case 'low':
                                severityLabel = 'Low';
                                severityDesc = 'Minor incident, no immediate danger';
                                severityClass = 'bg-secondary';
                                break;
                            default:
                                severityLabel = 'Unknown';
                                severityDesc = '';
                                severityClass = 'bg-light text-dark';
                        }
                        const li = document.createElement('li');
                        li.innerHTML = `${icon} <strong>${incident.title}</strong> in ${location}. <span class="badge ${severityClass} ms-2">${severityLabel}</span> <span class="text-muted">${time}</span><br><small class="text-muted">${severityDesc}</small>`;
                        alertsList.appendChild(li);
                    });
                } else {
                    alertsList.innerHTML = '<li>No recent incidents.</li>';
                }
            })
            .catch(() => {
                const alertsList = document.getElementById('live-alerts');
                alertsList.innerHTML = '<li>Error loading alerts.</li>';
            });
    }
    fetchLiveAlerts();
    setInterval(fetchLiveAlerts, 30000);
});
</script>
{% endblock %}

{% block content %}

<style>
#bg-slideshow {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100vw;
    height: 100vh;
    z-index: 0;
    opacity: 0.40;
    pointer-events: none;
    transition: background-image 1s ease-in-out;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}
#main-content {
    position: relative;
    z-index: 1;
}
</style>
<div id="bg-slideshow"></div>
<div id="main-content">
<div class="container mt-5">

    <div class="row align-items-center mb-5">
        <div class="col-md-7 text-center text-md-start">
            <h1 class="display-4 fw-bold text-danger mb-3">
                Disaster Response & Emergency Management
            </h1>
            <p class="lead mb-4">
                Real-time incident reporting, resource allocation, and emergency alerts for a safer Kenya.
            </p>
            <div class="d-flex flex-wrap gap-3 justify-content-center justify-content-md-start">
                <a href="/report_incident" class="btn btn-danger btn-lg"><i class="fas fa-exclamation-circle me-2"></i>Report Incident</a>
                <a href="/request_help" class="btn btn-warning btn-lg"><i class="fas fa-hands-helping me-2"></i>Request Help</a>
                <a href="/view_resources" class="btn btn-success btn-lg"><i class="fas fa-warehouse me-2"></i>View Resources</a>
                {% if current_user.is_authenticated and current_user.role == 'admin' %}
                <a href="/add_resource" class="btn btn-outline-success btn-lg"><i class="fas fa-plus me-2"></i>Add Resource</a>
                {% endif %}
            </div>
        </div>
        <div class="col-md-5 text-center mt-4 mt-md-0">
            <img src="{{ url_for('static', filename='logo/respo.png') }}" alt="Disaster Response" class="img-fluid" style="max-height: 260px;">
        </div>
    </div>
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-danger shadow-sm">
                <div class="card-header bg-danger text-white">
                    <i class="fas fa-bolt"></i> Live Alerts & Recent Incidents
                </div>
                <div class="card-body p-3">
                    <ul class="list-unstyled mb-0" id="live-alerts">
                        <li><i class="fas fa-exclamation-triangle text-danger"></i> <strong>Flood reported</strong> in Kisumu County. <span class="text-muted">2 mins ago</span></li>
                        <li><i class="fas fa-fire text-warning"></i> <strong>Fire outbreak</strong> in Nairobi CBD. <span class="text-muted">10 mins ago</span></li>
                        <li><i class="fas fa-car-crash text-primary"></i> <strong>Road accident</strong> on Mombasa Road. <span class="text-muted">20 mins ago</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-5 text-center">
        <div class="col-md-4 mb-3">
            <div class="card border-danger h-100">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                    <h5>Incidents Reported</h5>
                    <h2 class="text-danger">{{ stats.incident_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-warning h-100">
                <div class="card-body">
                    <i class="fas fa-user-shield fa-2x text-warning mb-2"></i>
                    <h5>Active Responders</h5>
                    <h2 class="text-warning">{{ stats.responder_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-success h-100">
                <div class="card-body">
                    <i class="fas fa-warehouse fa-2x text-success mb-2"></i>
                    <h5>Resources Available</h5>
                    <h2 class="text-success">{{ stats.resource_count }}</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Disaster Management &amp; Risk Management at Kenya Red Cross</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-danger">Disaster Management Operations (DM-Op)</h6>
                    <p>The Disaster Management Operations (DM-Op) department provides immediate relief to affected populations to save lives, protect livelihoods, and strengthen recovery from disasters and crises. The department’s key activities are in Emergency operations, Tracing and Restoration of Family links, Refugee Operations in Dadaab and Kalobeyei, protected relief and Recovery Operations, as well as Disaster Management strengthening.</p>
                    <h6 class="text-danger">Disaster Risk Management (DRM)</h6>
                    <p>The Disaster Risk Management (DRM) department is the organization’s flagship for resilience building. It implements programmes that aim to lessen or transfer the adverse effects of hazards through preparedness, mitigation and response. The focus is on three thematic areas; Disaster Risk Reduction (DRR), Food Security and Livelihood (FS&amp;L) and environmental management and climate change adaptation (E/CCA)</p>
                </div>
            </div>
        </div>
    </div>


    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-info-circle"></i> Disaster Preparedness Tips
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Have an emergency kit ready with water, food, and first aid supplies.</li>
                        <li>Know your local emergency contacts and evacuation routes.</li>
                        <li>Stay informed via SMS alerts and local news.</li>
                        <li>Help neighbors and vulnerable community members.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>


    <div class="row mb-5">
        <div class="col-12 text-center">
            <a href="{{ url_for('auth.login') }}" class="btn btn-lg btn-danger me-2">Login</a>
            <a href="{{ url_for('auth.register') }}" class="btn btn-lg btn-success">Register</a>
        </div>
    </div>

    <div class="row">
        <div class="col-12 text-center">
            <div class="small"><a href="#">Need Help? Contact Support</a></div>
        </div>
    </div>
</div>
{% endblock %}
